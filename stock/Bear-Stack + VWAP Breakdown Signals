//@version=6
indicator('Bear-Stack + VWAP Breakdown Signals', overlay=true, max_labels_count=20)

// ───── INPUTS ─────
// Volume threshold inputs with smart defaults
megaCapThreshold = input.float(2.5, 'Mega-Cap Volume Threshold', minval=1.0, maxval=10.0, group='Volume Thresholds', tooltip='For TSLA, NVDA, AAPL, GOOGL, AMZN')
largeCapThreshold = input.float(1.7, 'Large-Cap Volume Threshold', minval=1.0, maxval=10.0, group='Volume Thresholds', tooltip='For CRWV, RDDT, SMCI, AMD, PLTR')
midCapThreshold = input.float(1.3, 'Mid-Cap Volume Threshold', minval=1.0, maxval=10.0, group='Volume Thresholds', tooltip='For HOOD, HIMS, ROKU, RIVN, TEM')
smallCapThreshold = input.float(3.0, 'Small-Cap Volume Threshold', minval=1.0, maxval=10.0, group='Volume Thresholds', tooltip='For MARA, GME, SNAP, SQQQ, SPCE, IONQ, RGTI, ARQQ, QUBT, QBTS')
defaultThreshold = input.float(1.7, 'Default Volume Threshold', minval=1.0, maxval=10.0, group='Volume Thresholds', tooltip='For any other stocks not listed above')

// ───── DYNAMIC VOLUME THRESHOLDS ─────
// Function to determine volume threshold based on ticker and user inputs
getVolumeThreshold() =>
    ticker = syminfo.ticker
    
    // Mega-Cap Stocks
    if ticker == "TSLA" or ticker == "NVDA" or ticker == "AAPL" or ticker == "GOOGL" or ticker == "AMZN"
        megaCapThreshold
    // Large-Cap Stocks
    else if ticker == "CRWV" or ticker == "RDDT" or ticker == "SMCI" or ticker == "AMD" or ticker == "PLTR"
        largeCapThreshold
    // Mid-Cap Stocks
    else if ticker == "HOOD" or ticker == "HIMS" or ticker == "ROKU" or ticker == "RIVN" or ticker == "TEM"
        midCapThreshold
    // Small-Cap & Quantum Stocks
    else if ticker == "MARA" or ticker == "GME" or ticker == "SNAP" or ticker == "SQQQ" or ticker == "SPCE" or ticker == "IONQ" or ticker == "RGTI" or ticker == "ARQQ" or ticker == "QUBT" or ticker == "QBTS"
        smallCapThreshold
    // Default fallback
    else
        defaultThreshold

dynamicVolumeThreshold = getVolumeThreshold()
vwapTouchDistance = input.float(0.1, 'VWAP Touch Distance %', minval=0.01, maxval=1.0)
trendLength = input.int(20, 'Trend Detection Length', minval=5, maxval=50)
showAllSignals = input.bool(false, 'Show Individual VWAP Signals', group='Display')  // Kept for compatibility but not used
showBearStack = input.bool(false, 'Show Bear-Stack Levels', group='Display')
showPerfectAlignment = input.bool(false, 'Show Perfect Alignment Labels', group='Display', tooltip='Not used - kept for compatibility')

// ───── TIME HELPERS (New York) ─────
t(hh, mm) => timestamp('America/New_York', year, month, dayofmonth, hh, mm)

pmStart = t(4, 0)
mktOpen = t(9, 30)
orbEnd = t(9, 45)

isPremkt = time >= pmStart and time < mktOpen
inORB = time >= mktOpen and time < orbEnd
isNewSess = ta.change(time('D')) != 0

// ───── BEAR-STACK STRUCTURE (with smooth transitions) ─────
var float pml = na
var float pmh = na
var float orbLow = na
var float orbHigh = na
var bool orbLocked = false

// Store previous day's values for smooth transitions
var float prev_pml = na
var float prev_pmh = na
var float prev_orbLow = na
var float prev_orbHigh = na

if isNewSess
    // Store previous day's values before resetting
    prev_pml := pml
    prev_pmh := pmh
    if orbLocked
        prev_orbLow := orbLow
        prev_orbHigh := orbHigh
    
    // Reset for new day
    pml := na
    pmh := na
    orbLow := na
    orbHigh := na
    orbLocked := false

if isPremkt
    pml := na(pml) ? low : math.min(pml, low)
    pmh := na(pmh) ? high : math.max(pmh, high)

if not orbLocked and inORB
    orbLow := na(orbLow) ? low : math.min(orbLow, low)
    orbHigh := na(orbHigh) ? high : math.max(orbHigh, high)

if not orbLocked and time >= orbEnd
    orbLocked := true

// Use smooth transition values for plotting
pml_plot = na(pml) ? prev_pml : pml
pmh_plot = na(pmh) ? prev_pmh : pmh
orbLow_plot = orbLocked ? orbLow : prev_orbLow
orbHigh_plot = orbLocked ? orbHigh : prev_orbHigh

orbLocked_current = not na(orbHigh_plot) and not na(orbLow_plot) and time >= orbEnd
// BEAR-STACK: 15-minute high < PMH AND 15-minute low < PML (bearish stacked down formation)
bearStack = orbLocked_current and not na(pmh_plot) and not na(pml_plot) and orbHigh_plot < pmh_plot and orbLow_plot < pml_plot

// ───── VWAP & TREND ANALYSIS ─────
vwapValue = ta.vwap(hlc3)
ma = ta.sma(close, trendLength)

// Trend conditions (only downtrend needed now)
downtrend = close < ma and ma < ma[5]

// VWAP position
aboveVwap = close > vwapValue
belowVwap = close < vwapValue
vwapDistance = math.abs(close - vwapValue) / close * 100
nearVwap = vwapDistance <= vwapTouchDistance

// Volume conditions (using dynamic threshold)
avgVolume = ta.sma(volume, 20)
currentVolumeRatio = volume / avgVolume
highVolume = volume > avgVolume * dynamicVolumeThreshold

// Volume classification (using dynamic threshold)
lowVolumeMultiplier = 0.6
volumeStatus = currentVolumeRatio >= dynamicVolumeThreshold ? 'HIGH' : currentVolumeRatio <= lowVolumeMultiplier ? 'LOW' : 'NORMAL'

// ───── VWAP SIGNAL DETECTION (simplified) ─────
// Only keeping what's needed for breakdown setup
crossedBelowVwap = ta.crossunder(close, vwapValue)

// ───── PERFECT ALIGNMENT DETECTION ─────
// All three table conditions are met
perfectAlignment = bearStack and downtrend and belowVwap
perfectAlignmentNew = perfectAlignment and not perfectAlignment[1]

// ───── PREMIUM COMBINED SIGNALS (only BREAKDOWN SETUP) ─────
// BREAKDOWN SETUP - The only signal we want
breakdownSetup = bearStack and downtrend and belowVwap and highVolume and close < open

// Prevent multiple signals per bar
breakdownSetupNew = breakdownSetup and not breakdownSetup[1]

// ───── PLOTS (using smooth transition values) ─────
// Bear-Stack levels (optional)
plot(showBearStack ? orbHigh_plot : na, title='15-H', color=color.red, linewidth=2)
plot(showBearStack ? orbLow_plot : na, title='15-L', color=color.maroon, linewidth=2)
plot(showBearStack ? pmh_plot : na, title='PMH', color=color.purple, linewidth=2)
plot(showBearStack ? pml_plot : na, title='PML', color=color.orange, linewidth=2)

// VWAP (hidden by default since you have it in Bull indicator)
showVwap = input.bool(false, 'Show VWAP Line', group='Display')
plot(showVwap ? vwapValue : na, color=color.rgb(152, 134, 0), linewidth=1, title='VWAP')

// Individual VWAP signals - REMOVED (not needed)

// ───── PREMIUM SIGNALS (only BREAKDOWN SETUP) ─────
if breakdownSetupNew and barstate.isconfirmed
    label.new(bar_index, high, "BREAKDOWN SETUP", 
              style=label.style_label_down, color=color.maroon, textcolor=color.white, size=size.small)

// Perfect alignment visual indicator - REMOVED (not needed)

// Highlight first 15-minute ORB window
bgcolor(inORB ? color.new(color.yellow, 80) : na)

// Special background for BREAKDOWN SETUP
bgcolor(breakdownSetupNew ? color.new(color.red, 70) : na)

// Perfect alignment background - REMOVED (not needed)

// ───── DYNAMIC LABELS (that stay on screen) ─────
var label lblPMH = na
var label lblPML = na
var label lblHi15 = na
var label lblLo15 = na

if isNewSess // create fresh labels at the first bar of each day
    lblPMH := label.new(bar_index, na, '', style=label.style_label_left, color=color.purple, textcolor=color.white, size=size.small)
    lblPML := label.new(bar_index, na, '', style=label.style_label_left, color=color.orange, textcolor=color.white, size=size.small)
    lblHi15 := label.new(bar_index, na, '', style=label.style_label_left, color=color.red, textcolor=color.white, size=size.small)
    lblLo15 := label.new(bar_index, na, '', style=label.style_label_left, color=color.maroon, textcolor=color.white, size=size.small)

// Update positions & text each bar (using plot values for consistency)
if showBearStack and not na(pmh_plot) and not na(pml_plot)
    label.set_xy(lblPMH, bar_index, pmh_plot)
    label.set_xy(lblPML, bar_index, pml_plot)
    label.set_text(lblPMH, 'PMH  ' + str.tostring(pmh_plot, format.mintick))
    label.set_text(lblPML, 'PML  ' + str.tostring(pml_plot, format.mintick))

if showBearStack and not na(orbHigh_plot) and not na(orbLow_plot)
    label.set_xy(lblHi15, bar_index, orbHigh_plot)
    label.set_xy(lblLo15, bar_index, orbLow_plot)
    label.set_text(lblHi15, '15-M High  ' + str.tostring(orbHigh_plot, format.mintick))
    label.set_text(lblLo15, '15-M Low   ' + str.tostring(orbLow_plot, format.mintick))

// ───── PREMIUM ALERTS (only BREAKDOWN SETUP) ─────
alertcondition(breakdownSetupNew and barstate.isconfirmed, 
               title='🔻 BREAKDOWN SETUP', 
               message='❗❗❗{{ticker}} - BREAKDOWN SETUP: ENTER SHORT IMMEDIATELY - Price: {{close}}')

// ───── STATUS TABLE ─────
var table infoTable = table.new(position.middle_right, 2, 5, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, 'STATUS', text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(infoTable, 1, 0, 'CONDITION', text_color=color.white, bgcolor=color.navy, text_size=size.small)
    
    table.cell(infoTable, 0, 1, 'Bear-Stack', text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, bearStack ? 'ACTIVE' : 'WAITING', 
               text_color=bearStack ? color.red : color.gray, bgcolor=bearStack ? color.new(color.red, 80) : na, text_size=size.small)
    
    table.cell(infoTable, 0, 2, 'Trend', text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, downtrend ? 'DOWN' : 'SIDEWAYS', 
               text_color=downtrend ? color.red : color.gray, text_size=size.small)
    
    table.cell(infoTable, 0, 3, 'VWAP Pos', text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 3, belowVwap ? 'BELOW' : 'ABOVE', 
               text_color=belowVwap ? color.red : color.green, text_size=size.small)
    
    // Display current volume threshold
    table.cell(infoTable, 0, 4, 'Vol Threshold', text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(dynamicVolumeThreshold, '#.#') + 'x', 
               text_color=color.blue, text_size=size.small)

// ───── INDIVIDUAL VWAP ALERTS - REMOVED (not needed) ─────

// Key Requirements for BREAKDOWN SETUP Alert:
// Bear-Stack structure must be active (15H < PMH AND 15L < PML)
// High volume (≥ dynamic threshold based on stock type)
// Downtrend direction
// Price below VWAP
// Red candle (close < open)
// Bar confirmed (not real-time)

// Dynamic Volume Thresholds by Stock Type:
// Mega-Cap (TSLA, NVDA, AAPL, GOOGL, AMZN): 2.5x
// Large-Cap (CRWV, RDDT, SMCI, AMD, PLTR): 1.7x  
// Mid-Cap (HOOD, HIMS, ROKU, RIVN, TEM): 1.3x
// Small-Cap/Quantum (MARA, GME, SNAP, SQQQ, SPCE, IONQ, RGTI, ARQQ, QUBT, QBTS): 3.0x
// Default: 1.7x